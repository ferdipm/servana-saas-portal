# Plan MVP Portal Servana (SaaS)

Este documento define quÃ© falta para considerar el **portal del restaurante** como un MVP sÃ³lido y vendible.

---

## 1. Estado actual (lo que YA tenemos âœ…)

- [x] **Auth bÃ¡sica con Supabase**
  - `app/page.tsx` protegido: redirige a `/login` si no hay usuario.
  - ResoluciÃ³n de `tenantId` con `getCurrentTenantId`.

- [x] **Layout de dashboard**
  - `DashboardShell` con sidebar moderno (Reservas, Pendientes, Clientes, Analytics, Ajustes).
  - Topbar fijo con tÃ­tulo â€œReservasâ€.

- [x] **Vista principal de reservas**
  - `SummaryCards` con:
    - Hoy
    - MaÃ±ana
    - Resto semana
    - Resto mes
  - `ReservationsView` con:
    - Filtro por texto (nombre, telÃ©fono, localizador, notas).
    - Filtro por estado.
    - Filtro por rango de fechas:
      - Botones rÃ¡pidos: **Hoy** y **+1 dÃ­a**.
      - Datepickers con calendario en espaÃ±ol.
    - VirtualizaciÃ³n de lista (performante con muchas reservas).
    - Formato de fecha/hora en espaÃ±ol (24h).

- [x] **Drawer lateral de detalle**
  - Apertura al hacer clic en una fila.
  - Datos mostrados:
    - Fecha y hora.
    - Comensales.
    - TelÃ©fono.
    - Localizador.
    - Origen (WhatsApp, etc.).
    - Estado actual con chip bonito y consistente.
  - Datos editables:
    - Comensales.
    - TelÃ©fono.
    - Notas internas.
  - BotÃ³n **Guardar cambios** con estilo translÃºcido.

- [x] **Cambio rÃ¡pido de estado**
  - Botones en el drawer:
    - Confirmada
    - Sentada
    - Finalizada
    - Cancelada
    - No-show
  - Todos con mismo tamaÃ±o y estilo â€œpremiumâ€.
  - Recarga automÃ¡tica de la lista tras cambiar estado o guardar.

- [x] **Modo â€œPendientesâ€ a nivel de UI**
  - NavegaciÃ³n con item **â€œPendientesâ€** en el sidebar.
  - `ReservationsView` soporta `initialStatus="pending"` y modo `isPendingMode`:
    - `/` â†’ oculta `pending`.
    - `/pending` â†’ muestra `pending` filtradas.

---

## 2. Alcance del MVP del portal

Lo que consideramos **MVP completo** para el portal:

1. **Gestionar reservas** cÃ³modamente:
   - Ver, filtrar, buscar, editar, cambiar estado.
   - Separar claramente reservas **Pendientes** de las demÃ¡s.

2. **Config bÃ¡sica del restaurante (tenant)**:
   - Datos de negocio.
   - Horarios bÃ¡sicos de reservas.
   - PolÃ­tica de confirmaciÃ³n:
     - Auto-confirmaciÃ³n.
     - ConfirmaciÃ³n manual (reservas entran como `pending`).

3. **Experiencia de usuario cerrada**:
   - Login / logout claros.
   - Alguna gestiÃ³n mÃ­nima de usuario (ver su email, botÃ³n de â€œSalirâ€).
   - Mensajes de error y loading razonables.

---

## 3. Checklist de tareas pendientes

### 3.1. AutenticaciÃ³n y cuenta de usuario

- [ ] **AÃ±adir botÃ³n de â€œCerrar sesiÃ³nâ€ en el portal**
  - Mostrarlo en el topbar (derecha) con el email del usuario o avatar.
  - AcciÃ³n: llamar a `supabase.auth.signOut()` y redirigir a `/login`.

- [ ] **PÃ¡gina de login pulida**
  - Comprobar:
    - Formulario de email + password / magic link (lo que uses).
    - Manejo de errores de credenciales.
  - PequeÃ±o texto de â€œÂ¿Has olvidado la contraseÃ±a?â€ con link a flujo de Supabase (aunque sea muy bÃ¡sico).

- [ ] **PÃ¡gina / estado de â€œNo autorizado / sesiÃ³n expiradaâ€**
  - Si hay error en `getUser()`, mostrar algo amigable:
    - â€œTu sesiÃ³n ha caducado, vuelve a entrarâ€.

---

### 3.2. Vista de â€œPendientesâ€ operativa al 100%

- [ ] **Crear `app/pending/page.tsx`** (si no estÃ¡ ya)
  - Muy parecido a `app/page.tsx` pero:
    - Usa `DashboardShell`.
    - Obtiene `tenantId`.
    - Renderiza:
      ```tsx
      <ReservationsView
        tenantId={tenantId}
        defaultTz={defaultTz}
        initialStatus="pending"
      />
      ```

- [ ] **Texto contextual en la vista de Pendientes**
  - Encima de `ReservationsView`, un subtÃ­tulo tipo:
    > â€œReservas pendientes de revisiÃ³n. Cuando las confirmes, dejarÃ¡n de aparecer aquÃ­.â€

- [ ] **Verificar filtro de estados en modo pending**
  - `statusOptions` en `isPendingMode` debe permitir cambiar de `pending` a `confirmed`, etc., para trabajar desde esa vista.

---

### 3.3. ConfiguraciÃ³n bÃ¡sica del restaurante (Settings)

- [ ] **Tabla / columnas necesarias en BD (si no estÃ¡n):**
  - En `tenants`:
    - `name` (ya deberÃ­a existir).
    - `max_party_size` (int, opcional).
    - `use_manual_confirmation` (boolean, `DEFAULT false`).
    - Campo simple para horarios, por ahora algo tipo:
      - `service_hours_json jsonb`  
        (ej: `{ "lunch": { "start": "13:00", "end": "15:30" }, "dinner": { "start": "20:00", "end": "23:00" } }`)

- [ ] **Crear server actions para Settings**
  - Archivo nuevo sugerido: `app/settings-actions.ts` o dentro de `app/actions.ts` con secciÃ³n de tenants:
    - `getTenantSettings(tenantId)`
    - `updateTenantSettings(tenantId, payload)`

- [ ] **Page de Ajustes en el portal**
  - `app/settings/page.tsx` (o `app/(settings)/page.tsx`):
    - Protegida por auth + tenant.
    - Formulario con:
      - Nombre del restaurante (solo lectura o editable).
      - `max_party_size`.
      - Toggle para `use_manual_confirmation`:
        - Texto explicando:
          > Si estÃ¡ activado, las reservas del bot entrarÃ¡n como â€œPendienteâ€ y deberÃ¡s confirmarlas manualmente.
      - Un campo simple para horarios:
        - Por ahora, por ejemplo:
          - â€œHorario comida (texto libre)â€
          - â€œHorario cena (texto libre)â€
        - MÃ¡s adelante se puede hacer estructurado.

- [ ] **Guardar cambios**
  - BotÃ³n â€œGuardar ajustesâ€ con mismo estilo translÃºcido que en el drawer.
  - Toast o mensaje sutil de â€œAjustes guardadosâ€.

---

### 3.4. IntegraciÃ³n de `use_manual_confirmation` con la lÃ³gica de negocio

> Nota: esto toca **mÃ¡s al bot** que al portal, pero lo dejamos ya especificado.

- [ ] **En el bot (backend), leer `use_manual_confirmation` del tenant**
  - Si `false` â†’ reservas entran como `confirmed`.
  - Si `true` â†’ reservas entran como `pending`.

- [ ] **Textos de respuesta del bot**
  - Modo auto-confirmaciÃ³n:
    - â€œTu reserva estÃ¡ confirmada para el dÃ­a X a las Yâ€¦â€
  - Modo manual:
    - â€œHemos recibido tu peticiÃ³n. El restaurante revisarÃ¡ disponibilidad y te confirmaremos en breve.â€

---

### 3.5. UX / Detallitos finales

- [ ] **Mensajes de error mÃ¡s claros**
  - En `ReservationsView` y en el Drawer, capturar errores de server actions y mostrar:
    - Un pequeÃ±o texto â€œNo se ha podido guardar, intÃ©ntalo de nuevoâ€.
    - Log en consola para debug (ya lo tienes en parte).

- [ ] **Estado â€œvacÃ­oâ€ mÃ¡s friendly**
  - Donde pone â€œNo hay reservasâ€, aÃ±adir un iconito o texto un poco mÃ¡s cÃ¡lido:
    > â€œTodavÃ­a no hay reservas en este rango. Prueba a cambiar la fecha.â€

- [ ] **Responsive**
  - Revisar cÃ³mo se ve:
    - En tablet (ancho medio).
    - En mÃ³vil:
      - La tabla puede convertirse en tarjetas apiladas (si quieres dejar eso para mÃ¡s adelante, mÃ¡rcalo como v2).

- [ ] **Indicador de loading mÃ¡s visual**
  - Reemplazar el simple â€œCargandoâ€¦â€ por un pequeÃ±o skeleton o spinner centrado en la tabla.

---

### 3.6. Hardening tÃ©cnico (v1, bÃ¡sico pero serio)

- [ ] **Revisar RLS en Supabase**
  - Asegurar que:
    - `reservations` solo se ve por `tenant_id` vÃ­a `tenant_users` y `auth.uid()`.
    - `tenants` y `tenant_users` tienen polÃ­ticas que impiden ver datos de otros tenants.

- [ ] **Limitar select en acciones**
  - `getReservations`: usar `.select()` con campos necesarios (si quieres optimizar).
  - Evitar exponer campos sensibles en el portal (si los hubiera).

- [ ] **Variables de entorno limpias**
  - Revisar `.env.local`:
    - `NEXT_PUBLIC_SUPABASE_URL`
    - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
    - Cualquier otra necesaria para el portal.

---

## 4. VersiÃ³n v2 (ideas futuras â€“ fuera de MVP)

Solo para que no se pierdan:

- [ ] **Vista de Analytics**
  - GrÃ¡ficos simples:
    - Reservas por dÃ­a.
    - No-show vs confirmadas.
    - Personas total por servicio.

- [ ] **GestiÃ³n de clientes**
  - PÃ¡gina â€œClientesâ€ con lista de clientes recurrentes.
  - Notas por cliente, nÂº de visitas, etc.

- [ ] **GestiÃ³n de equipo**
  - Invitar usuarios del restaurante por email.
  - Roles simples: â€œAdminâ€ vs â€œStaffâ€.

---

## 5. Resumen

Con lo que ya tenemos implementado, el portal estÃ¡ bastante avanzado en la parte **reservas**.  
Para cerrar un **MVP vendible**, los focos son:

1. **Pulir auth y UX de sesiÃ³n** (logout, errores).
2. **Terminar bien la vista de Pendientes** como â€œinboxâ€ del encargado.
3. **AÃ±adir pÃ¡gina de Ajustes del restaurante** con `use_manual_confirmation` y config mÃ­nima.
4. **RevisiÃ³n RLS y pequeÃ±os detalles de UX**.

Cuando estos puntos estÃ©n marcados como `[x]`, el portal estarÃ¡ listo para enseÃ±ar a restaurantes sin vergÃ¼enza ğŸ˜.