# Plan MVP Portal Servana (SaaS)

Este documento define qu√© falta para considerar el **portal del restaurante** como un MVP s√≥lido y vendible.

---

## 1. Estado actual (lo que YA tenemos ‚úÖ)

- [x] **Auth b√°sica con Supabase**
  - `app/page.tsx` protegido: redirige a `/login` si no hay usuario.
  - Resoluci√≥n de `tenantId` con `getCurrentTenantId`.

- [x] **Layout de dashboard**
  - `DashboardShell` con sidebar moderno (Reservas, Pendientes, Clientes, Analytics, Ajustes).
  - Topbar fijo con t√≠tulo ‚ÄúReservas‚Äù.

- [x] **Vista principal de reservas**
  - `SummaryCards` con:
    - Hoy
    - Ma√±ana
    - Resto semana
    - Resto mes
  - `ReservationsView` con:
    - Filtro por texto (nombre, tel√©fono, localizador, notas).
    - Filtro por estado.
    - Filtro por rango de fechas:
      - Botones r√°pidos: **Hoy** y **+1 d√≠a**.
      - Datepickers con calendario en espa√±ol.
    - Virtualizaci√≥n de lista (performante con muchas reservas).
    - Formato de fecha/hora en espa√±ol (24h).

- [x] **Drawer lateral de detalle**
  - Apertura al hacer clic en una fila.
  - Datos mostrados:
    - Fecha y hora.
    - Comensales.
    - Tel√©fono.
    - Localizador.
    - Origen (WhatsApp, etc.).
    - Estado actual con chip bonito y consistente.
  - Datos editables:
    - Comensales.
    - Tel√©fono.
    - Notas internas.
  - Bot√≥n **Guardar cambios** con estilo transl√∫cido.

- [x] **Cambio r√°pido de estado**
  - Botones en el drawer:
    - Confirmada
    - Sentada
    - Finalizada
    - Cancelada
    - No-show
  - Todos con mismo tama√±o y estilo ‚Äúpremium‚Äù.
  - Recarga autom√°tica de la lista tras cambiar estado o guardar.

- [x] **Modo ‚ÄúPendientes‚Äù a nivel de UI**
  - Navegaci√≥n con item **‚ÄúPendientes‚Äù** en el sidebar.
  - `ReservationsView` soporta `initialStatus="pending"` y modo `isPendingMode`:
    - `/` ‚Üí oculta `pending`.
    - `/pending` ‚Üí muestra `pending` filtradas.

---

## 2. Alcance del MVP del portal

Lo que consideramos **MVP completo** para el portal:

1. **Gestionar reservas** c√≥modamente:
   - Ver, filtrar, buscar, editar, cambiar estado.
   - Separar claramente reservas **Pendientes** de las dem√°s.

2. **Config b√°sica del restaurante (tenant)**:
   - Datos de negocio.
   - Horarios b√°sicos de reservas.
   - Pol√≠tica de confirmaci√≥n:
     - Auto-confirmaci√≥n.
     - Confirmaci√≥n manual (reservas entran como `pending`).

3. **Experiencia de usuario cerrada**:
   - Login / logout claros.
   - Alguna gesti√≥n m√≠nima de usuario (ver su email, bot√≥n de ‚ÄúSalir‚Äù).
   - Mensajes de error y loading razonables.

---

## 3. Checklist de tareas pendientes

### 3.1. Autenticaci√≥n y cuenta de usuario

- [ ] **A√±adir bot√≥n de ‚ÄúCerrar sesi√≥n‚Äù en el portal**
  - Mostrarlo en el topbar (derecha) con el email del usuario o avatar.
  - Acci√≥n: llamar a `supabase.auth.signOut()` y redirigir a `/login`.

- [ ] **P√°gina de login pulida**
  - Comprobar:
    - Formulario de email + password / magic link (lo que uses).
    - Manejo de errores de credenciales.
  - Peque√±o texto de ‚Äú¬øHas olvidado la contrase√±a?‚Äù con link a flujo de Supabase (aunque sea muy b√°sico).

- [ ] **P√°gina / estado de ‚ÄúNo autorizado / sesi√≥n expirada‚Äù**
  - Si hay error en `getUser()`, mostrar algo amigable:
    - ‚ÄúTu sesi√≥n ha caducado, vuelve a entrar‚Äù.

---

### 3.2. Vista de ‚ÄúPendientes‚Äù operativa al 100%

- [x] **Crear `app/pending/page.tsx`** (si no est√° ya)
  - Muy parecido a `app/page.tsx` pero:
    - Usa `DashboardShell`.
    - Obtiene `tenantId`.
    - Renderiza:
      ```tsx
      <ReservationsView
        tenantId={tenantId}
        defaultTz={defaultTz}
        initialStatus="pending"
      />
      ```

- [ ] **Texto contextual en la vista de Pendientes**
  - Encima de `ReservationsView`, un subt√≠tulo tipo:
    > ‚ÄúReservas pendientes de revisi√≥n. Cuando las confirmes, dejar√°n de aparecer aqu√≠.‚Äù

- [ ] **Verificar filtro de estados en modo pending**
  - `statusOptions` en `isPendingMode` debe permitir cambiar de `pending` a `confirmed`, etc., para trabajar desde esa vista.

---

### 3.3. Configuraci√≥n b√°sica del restaurante (Settings)

- [ ] **Tabla / columnas necesarias en BD (si no est√°n):**
  - En `tenants`:
    - `name` (ya deber√≠a existir).
    - `max_party_size` (int, opcional).
    - `use_manual_confirmation` (boolean, `DEFAULT false`).
    - Campo simple para horarios, por ahora algo tipo:
      - `service_hours_json jsonb`  
        (ej: `{ "lunch": { "start": "13:00", "end": "15:30" }, "dinner": { "start": "20:00", "end": "23:00" } }`)

- [ ] **Crear server actions para Settings**
  - Archivo nuevo sugerido: `app/settings-actions.ts` o dentro de `app/actions.ts` con secci√≥n de tenants:
    - `getTenantSettings(tenantId)`
    - `updateTenantSettings(tenantId, payload)`

- [ ] **Page de Ajustes en el portal**
  - `app/settings/page.tsx` (o `app/(settings)/page.tsx`):
    - Protegida por auth + tenant.
    - Formulario con:
      - Nombre del restaurante (solo lectura o editable).
      - `max_party_size`.
      - Toggle para `use_manual_confirmation`:
        - Texto explicando:
          > Si est√° activado, las reservas del bot entrar√°n como ‚ÄúPendiente‚Äù y deber√°s confirmarlas manualmente.
      - Un campo simple para horarios:
        - Por ahora, por ejemplo:
          - ‚ÄúHorario comida (texto libre)‚Äù
          - ‚ÄúHorario cena (texto libre)‚Äù
        - M√°s adelante se puede hacer estructurado.

- [ ] **Guardar cambios**
  - Bot√≥n ‚ÄúGuardar ajustes‚Äù con mismo estilo transl√∫cido que en el drawer.
  - Toast o mensaje sutil de ‚ÄúAjustes guardados‚Äù.

---

### 3.4. Integraci√≥n de `use_manual_confirmation` con la l√≥gica de negocio

> Nota: esto toca **m√°s al bot** que al portal, pero lo dejamos ya especificado.

- [ ] **En el bot (backend), leer `use_manual_confirmation` del tenant**
  - Si `false` ‚Üí reservas entran como `confirmed`.
  - Si `true` ‚Üí reservas entran como `pending`.

- [ ] **Textos de respuesta del bot**
  - Modo auto-confirmaci√≥n:
    - ‚ÄúTu reserva est√° confirmada para el d√≠a X a las Y‚Ä¶‚Äù
  - Modo manual:
    - ‚ÄúHemos recibido tu petici√≥n. El restaurante revisar√° disponibilidad y te confirmaremos en breve.‚Äù

---

### 3.5. UX / Detallitos finales

- [ ] **Mensajes de error m√°s claros**
  - En `ReservationsView` y en el Drawer, capturar errores de server actions y mostrar:
    - Un peque√±o texto ‚ÄúNo se ha podido guardar, int√©ntalo de nuevo‚Äù.
    - Log en consola para debug (ya lo tienes en parte).

- [ ] **Estado ‚Äúvac√≠o‚Äù m√°s friendly**
  - Donde pone ‚ÄúNo hay reservas‚Äù, a√±adir un iconito o texto un poco m√°s c√°lido:
    > ‚ÄúTodav√≠a no hay reservas en este rango. Prueba a cambiar la fecha.‚Äù

- [ ] **Responsive**
  - Revisar c√≥mo se ve:
    - En tablet (ancho medio).
    - En m√≥vil:
      - La tabla puede convertirse en tarjetas apiladas (si quieres dejar eso para m√°s adelante, m√°rcalo como v2).

- [ ] **Indicador de loading m√°s visual**
  - Reemplazar el simple ‚ÄúCargando‚Ä¶‚Äù por un peque√±o skeleton o spinner centrado en la tabla.

---

### 3.6. Hardening t√©cnico (v1, b√°sico pero serio)

- [ ] **Revisar RLS en Supabase**
  - Asegurar que:
    - `reservations` solo se ve por `tenant_id` v√≠a `tenant_users` y `auth.uid()`.
    - `tenants` y `tenant_users` tienen pol√≠ticas que impiden ver datos de otros tenants.

- [ ] **Limitar select en acciones**
  - `getReservations`: usar `.select()` con campos necesarios (si quieres optimizar).
  - Evitar exponer campos sensibles en el portal (si los hubiera).

- [ ] **Variables de entorno limpias**
  - Revisar `.env.local`:
    - `NEXT_PUBLIC_SUPABASE_URL`
    - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
    - Cualquier otra necesaria para el portal.

---

### 3.7. Reservas manuales:

## 3. Crear reservas manuales (tel√©fono / walk-in)

### 3.1 UX / UI

- [x] 3.1.1 A√±adir bot√≥n **‚Äú+ Nueva reserva‚Äù** en la vista principal de reservas (`/`), arriba a la derecha del listado.
- [x] 3.1.2 El bot√≥n abre el **mismo drawer de reserva** pero en **modo creaci√≥n** (sin datos cargados).
- [x] 3.1.3 Campos visibles en el formulario de creaci√≥n:
  - [x] Nombre (obligatorio)
  - [x] Tel√©fono (opcional pero recomendado)
  - [x] N¬∫ de comensales (obligatorio)
  - [x] Fecha y hora (obligatorio ‚Äì date + time picker)
  - [x] Notas internas (opcional)
- [x] 3.1.4 Mostrar el **estado inicial** (solo lectura) como ‚ÄúConfirmada‚Äù para las reservas manuales.
- [x] 3.1.5 Textos claros para este flujo: ‚ÄúReserva creada manualmente (tel√©fono)‚Äù o similar en el drawer.

### 3.2 Backend ‚Äî acci√≥n `createReservation`

- [x] 3.2.1 Crear en `app/actions.ts` una server action `createReservation`.
- [x] 3.2.2 Par√°metros m√≠nimos de entrada:
  - tenantId (derivado del usuario logado)
  - name
  - phone (opcional)
  - party_size
  - datetime_local + tz (o directamente datetime_utc calculado en el front)
  - notes (opcional)
- [x] 3.2.3 Insert en la tabla `reservations`:
  - [x] `tenant_id` = tenant actual
  - [x] `source` = `"phone"`
  - [x] `status` = `"confirmed"` (de momento, fijo para manuales)
  - [x] `datetime_utc` calculado correctamente a partir de la hora local + tz
- [x] 3.2.4 Validaciones b√°sicas:
  - [x] No permitir `party_size <= 0`
  - [x] No permitir `datetime_utc` claramente en el pasado (salvo que decidamos lo contrario)
- [x] 3.2.5 Devolver `{ ok: true, id }` al front si todo va bien, o error claro si falla.

### 3.3 Integraci√≥n en el front

- [x] 3.3.1 A√±adir estado `creatingReservation` / `mode: "create" | "view"` en la vista para distinguir:
  - Drawer abierto por click en fila ‚Üí modo **vista/edici√≥n**
  - Drawer abierto por bot√≥n ‚Äú+ Nueva reserva‚Äù ‚Üí modo **creaci√≥n**
- [x] 3.3.2 En modo creaci√≥n:
  - [x] Inicializar los campos del formulario vac√≠os / con defaults.
  - [x] Bot√≥n principal ‚ÄúCrear reserva‚Äù en lugar de ‚ÄúGuardar cambios‚Äù.
  - [x] Al hacer submit:
    - [x] Llamar a `createReservation`
    - [x] Cerrar drawer
    - [x] Recargar la lista (`getReservations`) manteniendo filtros actuales.
- [x] 3.3.3 Manejo de errores:
  - [x] Mostrar mensaje de error si el create falla (toast o mensaje en el drawer).
  - [x] Desactivar bot√≥n mientras se est√° enviando (`loading` state).

### 3.4 Comportamiento con flujo de ‚Äúpendientes‚Äù

- [ ] 3.4.1 Definir comportamiento inicial simple:
  - Reservas creadas manualmente desde el portal ‚Üí **`status = confirmed`** siempre.
- [ ] 3.4.2 (A futuro) Anotar en el plan:
  - Posible ajuste por tenant: opci√≥n ‚ÄúLas reservas creadas manualmente entran como `pending`‚Äù.
- [ ] 3.4.3 Confirmar que las reservas manuales creadas:
  - [ ] Aparecen en la vista principal de reservas con el filtro por defecto (Hoy).
  - [ ] **No** aparecen en `/pending` (porque no son `pending`).

### 3.5 QA / Pruebas

- [ ] 3.5.1 Crear una reserva manual para hoy v√≠a portal y verificar:
  - [ ] Se guarda en Supabase correctamente (status, source, tenant_id, datetime_utc).
  - [ ] Se ve en la lista de reservas del d√≠a.
- [ ] 3.5.2 Probar cambiarla de estado desde el drawer (confirmada ‚Üí sentada ‚Üí finalizada, etc.).
- [ ] 3.5.3 Probar varios husos horarios (si aplican) para asegurarse de que el c√°lculo de `datetime_utc` es correcto.
- [ ] 3.5.4 Probar el caso de error:
  - [ ] Datos inv√°lidos (sin nombre, sin fecha‚Ä¶) ‚Üí que el formulario lo bloquee antes de llamar al backend.

## 4. Versi√≥n v2 (ideas futuras ‚Äì fuera de MVP)

Solo para que no se pierdan:

- [ ] **Vista de Analytics**
  - Gr√°ficos simples:
    - Reservas por d√≠a.
    - No-show vs confirmadas.
    - Personas total por servicio.

- [ ] **Gesti√≥n de clientes**
  - P√°gina ‚ÄúClientes‚Äù con lista de clientes recurrentes.
  - Notas por cliente, n¬∫ de visitas, etc.

- [ ] **Gesti√≥n de equipo**
  - Invitar usuarios del restaurante por email.
  - Roles simples: ‚ÄúAdmin‚Äù vs ‚ÄúStaff‚Äù.

---

## 5. Resumen

Con lo que ya tenemos implementado, el portal est√° bastante avanzado en la parte **reservas**.  
Para cerrar un **MVP vendible**, los focos son:

1. **Pulir auth y UX de sesi√≥n** (logout, errores).
2. **Terminar bien la vista de Pendientes** como ‚Äúinbox‚Äù del encargado.
3. **A√±adir p√°gina de Ajustes del restaurante** con `use_manual_confirmation` y config m√≠nima.
4. **Revisi√≥n RLS y peque√±os detalles de UX**.

Cuando estos puntos est√©n marcados como `[x]`, el portal estar√° listo para ense√±ar a restaurantes sin verg√ºenza üòè.